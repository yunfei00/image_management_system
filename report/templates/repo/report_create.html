{% extends 'base.html' %}

{% block content %}
<!-- 搜索表单 -->
<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <input class="form-control" name="type" placeholder="报表类型" value="{{ request.GET.type }}">
  </div>
  <div class="col-auto">
    <input class="form-control" name="period" placeholder="时间段" value="{{ request.GET.period }}">
  </div>
  <div class="col-auto">
    <select name="status" class="form-select">
      <option value="">状态</option>
      <option value="1" {% if request.GET.status == '1' %}selected{% endif %}>启用</option>
      <option value="0" {% if request.GET.status == '0' %}selected{% endif %}>停用</option>
    </select>
  </div>
  <div class="col-auto">
    <button class="btn btn-primary">搜索</button>
    <a class="btn btn-success" href="?{% if request.GET.type %}type={{ request.GET.type }}&{% endif %}{% if request.GET.period %}period={{ request.GET.period }}&{% endif %}{% if request.GET.status %}status={{ request.GET.status }}&{% endif %}export=1">导出</a>
  </div>
  <div class="col-auto ms-auto text-end">
    <button type="button" class="btn btn-outline-primary" onclick="openModal('{% url 'system:report_create' %}', '新增报表')">新增</button>
  </div>
</form>

<!-- 报表数据表格 -->
<table class="table table-bordered">
  <thead class="table-light">
    <tr><th><input id="selectAll" type="checkbox" /></th><th>报表类型</th><th>时间段</th><th>状态</th><th>创建时间</th><th>操作</th></tr>
  </thead>
  <tbody>
    {% for obj in page_obj %}
      <tr>
        <td><input type="checkbox" class="rowCheckbox" value="{{ obj.id }}"></td>
        <td>{{ obj.get_type_display }}</td>
        <td>{{ obj.period }}</td>
        <td>{{ obj.get_status_display }}</td>
        <td>{{ obj.created_at }}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="openModal('{% url 'system:report_edit' obj.id %}', '编辑报表')">修改</button>
          <button class="btn btn-sm btn-danger" onclick="postDelete('{% url 'system:report_delete' obj.id %}')">删除</button>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="6" class="text-center text-muted">暂无数据</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- 分页 -->
{% include "system/includes/pagination.html" %}

<script>
  // 全选功能
  document.getElementById('selectAll')?.addEventListener('change', function(e){
    document.querySelectorAll('.rowCheckbox').forEach(ch => ch.checked = e.target.checked);
  });

  // 删除报表的函数
  async function postDelete(url){
    if(!confirm('确认删除？')) return;
    const resp = await fetch(url, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken')}
    });
    const data = await resp.json();
    if(data.success) location.reload();
    else alert('删除失败');
  }
</script>

<!-- 新增报表模态框 -->
{% block modal %}
  <div id="modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">新增报表</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="POST" action="{% url 'system:report_create' %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">保存</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% endblock %}
