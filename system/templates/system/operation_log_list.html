{% extends 'base.html' %}
{% block content %}
<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <input class="form-control" name="module" placeholder="系统模块" value="{{ request.GET.module }}">
  </div>
  <div class="col-auto">
    <input class="form-control" name="operator" placeholder="操作人员" value="{{ request.GET.operator }}">
  </div>
  <div class="col-auto">
    <input class="form-control" name="ip" placeholder="操作IP" value="{{ request.GET.ip }}">
  </div>
  <div class="col-auto">
    <input type="date" class="form-control" name="start_time" value="{{ request.GET.start_time }}">
  </div>
  <div class="col-auto">
    <input type="date" class="form-control" name="end_time" value="{{ request.GET.end_time }}">
  </div>
  <div class="col-auto">
    <button class="btn btn-primary">搜索</button>
    <a class="btn btn-success" href="?{% if request.GET.module %}module={{ request.GET.module }}&{% endif %}{% if request.GET.operator %}operator={{ request.GET.operator }}&{% endif %}{% if request.GET.ip %}ip={{ request.GET.ip }}&{% endif %}{% if request.GET.start_time %}start_time={{ request.GET.start_time }}&{% endif %}{% if request.GET.end_time %}end_time={{ request.GET.end_time }}&{% endif %}export=1">导出</a>
  </div>
</form>

<form id="bulk-form">
  <div class="mb-2">
    <button type="button" id="btn-delete" class="btn btn-danger">删除选中</button>
  </div>

  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr class="text-center">
        <th><input id="selectAll" type="checkbox" /></th>
        <th>操作时间</th>
        <th>系统模块</th>
        <th>操作人员</th>
        <th>操作IP</th>
        <th>操作内容</th>
        <th>操作</th> <!-- ✅ 新增删除列 -->
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
        <tr class="text-center">
          <td><input type="checkbox" class="rowCheckbox" value="{{ log.id }}" /></td>
          <td>{{ log.operation_time|date:"Y-m-d H:i:s" }}</td>
          <td>{{ log.module }}</td>
          <td>{{ log.operator }}</td>
          <td>{{ log.ip }}</td>
          <td>{{ log.operation_content }}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="postDelete('{% url 'system:oper_log_delete' log.id %}')">删除</button>
          </td> <!-- ✅ 新增删除按钮 -->
        </tr>
      {% empty %}
        <tr><td colspan="7" class="text-center text-muted">暂无数据</td></tr>
      {% endfor %}
    </tbody>
  </table>
</form>

{% include "system/includes/pagination.html" %}

<script>
  // 全选
  document.getElementById('selectAll')?.addEventListener('change', function(e){
    document.querySelectorAll('.rowCheckbox').forEach(ch => ch.checked = e.target.checked);
  });

  // 批量删除
  document.getElementById('btn-delete').addEventListener('click', async function () {
    const ids = Array.from(document.querySelectorAll('.rowCheckbox:checked')).map(cb => cb.value);
    if (!ids.length) { alert('请先选择要删除的日志'); return; }
    if (!confirm(`确认删除 ${ids.length} 条？`)) return;
    const resp = await fetch('/api/logs/operation/bulk_delete/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
      body: JSON.stringify({ ids })
    });
    if (resp.ok) {
      alert('删除成功');
      location.reload();
    } else {
      alert('删除失败');
    }
  });

  // 获取CSRF Token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

{% endblock %}
