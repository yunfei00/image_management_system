{% load static %}
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}镜像管理系统{% endblock %}</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <style>
    :root {
      --primary-color: #165DFF;
      --secondary-color: #0F3FA8;
      --sidebar-bg: #0F172A;
      --sidebar-active: #1E293B;
      --text-primary: #F8FAFC;
      --text-secondary: #94A3B8;
      --content-bg: #F1F5F9;
      --card-bg: #FFFFFF;
      --border-color: #E2E8F0;
    }

    body {
      min-height: 100vh;
      overflow-x: hidden;
      background-color: var(--content-bg);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      padding-top: 56px;
    }

    /* ===== 固定侧边栏 + 独立滚动布局 ===== */
    html, body {
      height: 100%;
      overflow: hidden; /* 禁止整个页面滚动，由左右两侧独立滚动 */
    }

    .d-flex {
      height: calc(100vh - 56px);
      overflow: hidden;
    }

    #sidebar {
      width: 240px;
      background-color: var(--sidebar-bg);
      color: var(--text-primary);
      overflow-y: auto;
      overflow-x: hidden;
      height: calc(100vh - 56px);
      position: sticky;
      top: 56px;
      flex-shrink: 0;
    }

    /* 折叠菜单背景一致 */
    #sidebar .collapse {
      background-color: var(--sidebar-bg);
    }
    #sidebar .collapse .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }
    #sidebar .nav .nav {
      background-color: var(--sidebar-bg);
      border-left: 2px solid rgba(255, 255, 255, 0.05);
      padding-left: 0.5rem;
    }

    #content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      height: calc(100vh - 56px);
      background-color: var(--content-bg);
      padding: 1.5rem;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <!-- 顶部导航条 -->
  <nav class="navbar navbar-expand-lg fixed-top" style="background-color: var(--primary-color);">
    <div class="container-fluid">
      <button class="btn btn-outline-light me-2" id="btn-toggle-sidebar"><i class="bi bi-list"></i></button>
      <a class="navbar-brand fw-bold text-white" href="{% url 'system:home' %}"><i class="bi bi-server"></i> 镜像管理系统</a>
    </div>
  </nav>

  <div class="d-flex">
    <aside id="sidebar" class="p-3">
      {% comment %} 左侧导航菜单内容省略，保持原结构 {% endcomment %}
      {% block sidebar %}{% endblock %}
    </aside>

    <main id="content" class="p-4 flex-grow-1">
      <div class="container-fluid">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <script>
    // 侧边栏开关
    const btn = document.getElementById('btn-toggle-sidebar');
    const sidebar = document.getElementById('sidebar');
    if (localStorage.getItem('sidebarHidden') === 'true') sidebar.style.display = 'none';
    btn?.addEventListener('click', () => {
      const hidden = sidebar.style.display === 'none';
      sidebar.style.display = hidden ? 'block' : 'none';
      localStorage.setItem('sidebarHidden', !hidden);
    });

    // 通用折叠菜单记忆功能
    function setupPersistentCollapse(menuId) {
      const menu = document.getElementById(menuId);
      const toggle = document.querySelector(`a[href="#${menuId}"]`);
      if (!menu || !toggle) return;

      const saved = localStorage.getItem(menuId + 'Open');
      if (saved === 'true') {
        menu.classList.add('show');
        toggle.setAttribute('aria-expanded', 'true');
      }

      menu.addEventListener('show.bs.collapse', () => localStorage.setItem(menuId + 'Open', 'true'));
      menu.addEventListener('hide.bs.collapse', () => localStorage.setItem(menuId + 'Open', 'false'));

      menu.querySelectorAll('a.nav-link').forEach(link => {
        link.addEventListener('click', evt => {
          localStorage.setItem(menuId + 'Open', 'true');
          evt.stopPropagation();
        }, {capture: true});
      });
    }

    setupPersistentCollapse('systemMenu');
    setupPersistentCollapse('imageMenu');
    setupPersistentCollapse('detectionMenu');
  </script>
</body>
</html>
